<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HAJIB | مصمم الدعوات</title>
    
    <!-- مكتبات المعالجة -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <!-- الخطوط والأيقونات -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --bg: #111827; --panel: #1f2937; --primary: #3b82f6; --text: #f3f4f6; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; font-family: 'Tajawal', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        header { background: var(--panel); padding: 10px 15px; height: 50px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #374151; }
        .brand { font-weight: 800; color: var(--primary); font-size: 1.1rem; }
        .badge { background: #065f46; color: #34d399; padding: 3px 10px; border-radius: 15px; font-size: 0.75rem; }

        .workspace { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        .preview-container {
            flex: 1; background: #000; display: flex; justify-content: center; align-items: center;
            overflow: hidden; position: relative;
            background-image: radial-gradient(#333 1px, transparent 1px); background-size: 20px 20px;
        }
        canvas { max-width: 90%; max-height: 90%; box-shadow: 0 0 20px rgba(0,0,0,0.5); object-fit: contain; }

        .controls-panel {
            height: 50vh; background: var(--panel); border-top: 1px solid #374151;
            display: flex; flex-direction: column; z-index: 100;
        }

        .tabs { display: flex; background: #111827; }
        .tab-btn {
            flex: 1; padding: 12px; background: none; border: none; color: #9ca3af; 
            font-family: inherit; font-weight: bold; font-size: 0.9rem; border-bottom: 3px solid transparent;
        }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: #1f2937; }

        .tab-content { flex: 1; overflow-y: auto; padding: 15px; display: none; }
        .tab-content.active { display: block; }

        .control-row { margin-bottom: 18px; }
        .control-label { display: flex; justify-content: space-between; font-size: 0.85rem; color: #d1d5db; margin-bottom: 5px; }
        .val-badge { color: var(--primary); font-weight: bold; }
        
        input[type="range"] { width: 100%; height: 5px; background: #4b5563; border-radius: 5px; appearance: none; }
        input[type="range"]::-webkit-slider-thumb { appearance: none; width: 20px; height: 20px; background: var(--primary); border-radius: 50%; border: 2px solid white; cursor: pointer; }

        .actions { padding: 10px; background: #111827; display: flex; gap: 10px; flex-direction: column; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-family: inherit; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; color: white; }
        .btn-zip { background: var(--primary); }
        .btn-zip:disabled { background: #4b5563; }
        
        /* Loading Overlay */
        #progressOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 999;
            display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        .progress-bar { width: 80%; height: 10px; background: #333; border-radius: 5px; margin-top: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }
        .warning-msg { color: orange; font-size: 0.8rem; margin-top: 20px; max-width: 80%; }
        
        .chk-container { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; margin-bottom: 15px; }
        input[type="checkbox"] { width: 20px; height: 20px; }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="progressOverlay">
        <div id="statusIcon"><i class="fas fa-cog fa-spin" style="font-size: 3rem; color: var(--primary);"></i></div>
        <h3 id="progressText" style="margin-top: 20px; color:white;">جاري التجهيز...</h3>
        <p id="subProgressText" style="color:#9ca3af; font-size:0.9rem;">يرجى الانتظار</p>
        <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
        
        <p class="warning-msg">
            <i class="fas fa-exclamation-triangle"></i> ملاحظة: سيتم تحميل الملفات على دفعات. <br>
            يرجى السماح للمتصفح بتحميل عدة ملفات إذا طلب ذلك.
        </p>
        
        <button onclick="window.location.reload()" style="margin-top:20px; padding:8px 20px; background:transparent; border:1px solid #ef4444; color:#ef4444; border-radius:5px;">إيقاف وإعادة تحميل</button>
    </div>

    <header>
        <div class="brand">HAJIB DESIGNER</div>
        <div class="badge" id="guestCount">...</div>
    </header>

    <div class="workspace">
        <div class="preview-container">
            <canvas id="canvas"></canvas>
        </div>

        <div class="controls-panel">
            <div class="tabs">
                <button class="tab-btn active" onclick="setTab('main')">الصورة</button>
                <button class="tab-btn" onclick="setTab('text')">الاسم</button>
                <button class="tab-btn" onclick="setTab('qr')">الباركود</button>
            </div>

            <div id="tab-main" class="tab-content active">
                <div class="control-row">
                    <div class="control-label">رفع التصميم</div>
                    <input type="file" id="bgInput" accept="image/*" style="width:100%; padding:10px; background:#374151; border-radius:5px; color:white;">
                </div>
                
                <div class="control-row" style="margin-top:20px; border-top:1px solid #374151; padding-top:10px;">
                    <div class="control-label">
                        <span><i class="fas fa-boxes"></i> عدد الصور في الملف الواحد (Batch)</span>
                        <span id="val-batchSize" class="val-badge">15</span>
                    </div>
                    <input type="range" id="batchSize" min="5" max="50" value="15" step="5">
                    <p style="font-size:0.75rem; color:orange; margin-top:5px;">
                        * قلل هذا الرقم إذا كان هاتفك يتجمد (مثلاً اجعله 10).
                    </p>
                </div>
            </div>

            <div id="tab-text" class="tab-content">
                <div class="chk-container">
                    <input type="checkbox" id="showName" checked>
                    <label for="showName" style="margin:0; cursor:pointer;">إظهار اسم الضيف</label>
                </div>
                <div class="control-row">
                    <div class="control-label"><span>حجم الخط</span> <span id="val-textSize" class="val-badge">40</span></div>
                    <input type="range" id="textSize" min="10" max="150" value="40">
                </div>
                <div class="control-row">
                    <div class="control-label"><span>أفقي (X)</span> <span id="val-textX" class="val-badge">50</span></div>
                    <input type="range" id="textX" min="0" max="2000" value="50">
                </div>
                <div class="control-row">
                    <div class="control-label"><span>عمودي (Y)</span> <span id="val-textY" class="val-badge">300</span></div>
                    <input type="range" id="textY" min="0" max="2000" value="300">
                </div>
                <div class="control-row">
                    <div class="control-label">لون النص</div>
                    <input type="color" id="textColor" value="#ffffff" style="width:100%; height:40px; border:none; border-radius:5px;">
                </div>
            </div>

            <div id="tab-qr" class="tab-content">
                <div class="control-row">
                    <div class="control-label"><span>حجم الباركود</span> <span id="val-qrSize" class="val-badge">150</span></div>
                    <input type="range" id="qrSize" min="50" max="500" value="150">
                </div>
                <div class="control-row">
                    <div class="control-label"><span>أفقي (X)</span> <span id="val-qrX" class="val-badge">50</span></div>
                    <input type="range" id="qrX" min="0" max="2000" value="50">
                </div>
                <div class="control-row">
                    <div class="control-label"><span>عمودي (Y)</span> <span id="val-qrY" class="val-badge">50</span></div>
                    <input type="range" id="qrY" min="0" max="2000" value="50">
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-zip" onclick="startSplitProcessing()">
                    <i class="fas fa-file-archive"></i> بدء المعالجة والتحميل
                </button>
            </div>
        </div>
    </div>

    <div id="hiddenQR" style="display:none;"></div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzcJyxjZ4DcOKkboUYvDOrkWs5PVsKScetEzEvSXwzIL3sFGb0JHHVpTzZRksiaBJsW/exec';
        let guests = [];
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let bgImg = new Image();
        
        const state = {
            qrSize: 150, qrX: 50, qrY: 50,
            showName: true, textSize: 40, textX: 50, textY: 300, textColor: '#ffffff',
            batchSize: 15 // الافتراضي
        };

        bgImg.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA+gAAALQCAIAAACw5t5xAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAABTSURBVHhe7cExAQAAAMKg9U9tDQ8gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4McIsHgAAa1w1XEAAAAASUVORK5CYII=";
        bgImg.onload = draw;

        // Fetch Data
        fetch(API_URL, { method: 'POST', body: new URLSearchParams({action: 'getDetailedReport'}) })
            .then(r => r.json())
            .then(d => {
                if(d.success) {
                    guests = [...d.attendedGuests, ...d.notAttendedGuests];
                    document.getElementById('guestCount').innerText = `${guests.length} مدعو`;
                }
            })
            .catch(() => document.getElementById('guestCount').innerText = "خطأ");

        // UI Logic
        window.setTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + id).style.display = 'block';
            event.target.classList.add('active');
        };

        const bind = (id) => {
            const el = document.getElementById(id);
            el.addEventListener('input', (e) => {
                let val = e.target.type === 'checkbox' ? e.target.checked : e.target.value;
                if(e.target.type === 'range') val = parseInt(val);
                state[id] = val;
                const badge = document.getElementById('val-' + id);
                if(badge) badge.innerText = val;
                draw();
            });
        };
        ['qrSize', 'qrX', 'qrY', 'textSize', 'textX', 'textY', 'textColor', 'showName', 'batchSize'].forEach(bind);

        document.getElementById('bgInput').addEventListener('change', (e) => {
            if(e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    bgImg = new Image();
                    bgImg.onload = () => {
                        const max = Math.max(bgImg.width, bgImg.height);
                        ['qrX','qrY','textX','textY'].forEach(id => document.getElementById(id).max = max);
                        draw();
                    };
                    bgImg.src = evt.target.result;
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        function draw() {
            canvas.width = bgImg.width || 800;
            canvas.height = bgImg.height || 600;
            ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);

            ctx.fillStyle = "#000";
            ctx.fillRect(state.qrX, state.qrY, state.qrSize, state.qrSize);
            ctx.fillStyle = "#fff";
            ctx.fillRect(state.qrX + 5, state.qrY + 5, state.qrSize - 10, state.qrSize - 10);
            
            if(state.showName) {
                ctx.font = `bold ${state.textSize}px 'Tajawal'`;
                ctx.fillStyle = state.textColor;
                ctx.textAlign = 'right';
                ctx.fillText("اسم الضيف هنا", state.textX, state.textY);
            }
        }

        // --- نظام الدفعات المتطور (Split Processing) ---
        async function startSplitProcessing() {
            if(guests.length === 0) return alert("لا يوجد بيانات");

            const overlay = document.getElementById('progressOverlay');
            const pText = document.getElementById('progressText');
            const pSubText = document.getElementById('subProgressText');
            const pFill = document.getElementById('progressFill');
            
            overlay.style.display = 'flex';
            
            // تقسيم المدعوين إلى مجموعات (Chunks)
            const chunkSize = state.batchSize; 
            const totalChunks = Math.ceil(guests.length / chunkSize);
            const tempDiv = document.getElementById('hiddenQR');

            // دالة لمعالجة مجموعة واحدة وتحميلها وتنظيف الذاكرة
            const processChunk = async (chunkIndex) => {
                if (chunkIndex >= totalChunks) {
                    // انتهى الكل
                    pText.innerText = "تم الانتهاء!";
                    pSubText.innerText = "تم تحميل جميع الملفات.";
                    document.getElementById('statusIcon').innerHTML = '<i class="fas fa-check-circle" style="color:#10b981; font-size:3rem;"></i>';
                    setTimeout(() => overlay.style.display = 'none', 3000);
                    return;
                }

                // تجهيز ملف ZIP جديد لهذه الدفعة
                let zip = new JSZip(); // إنشاء جديد لكل دفعة
                let folder = zip.folder(`Batch_${chunkIndex + 1}`);
                
                const start = chunkIndex * chunkSize;
                const end = Math.min(start + chunkSize, guests.length);
                
                pText.innerText = `تجهيز الملف ${chunkIndex + 1} من ${totalChunks}`;
                
                // معالجة صور الدفعة الحالية
                for (let i = start; i < end; i++) {
                    const guest = guests[i];
                    pSubText.innerText = `رسم بطاقة: ${guest.name}`;
                    const percent = Math.round(((i + 1) / guests.length) * 100);
                    pFill.style.width = `${percent}%`;

                    // 1. QR Generation
                    tempDiv.innerHTML = '';
                    new QRCode(tempDiv, { text: guest.qrCode, width: state.qrSize, height: state.qrSize });
                    
                    // تأخير صغير لمنع التجميد
                    await new Promise(r => setTimeout(r, 100));

                    const qrImg = tempDiv.querySelector('img');
                    if(qrImg) {
                        const tCanvas = document.createElement('canvas');
                        tCanvas.width = canvas.width;
                        tCanvas.height = canvas.height;
                        const tCtx = tCanvas.getContext('2d');

                        tCtx.drawImage(bgImg, 0, 0);
                        tCtx.drawImage(qrImg, state.qrX, state.qrY, state.qrSize, state.qrSize);

                        if(state.showName) {
                            tCtx.font = `bold ${state.textSize}px 'Tajawal'`;
                            tCtx.fillStyle = state.textColor;
                            tCtx.textAlign = 'right';
                            tCtx.fillText(guest.name, state.textX, state.textY);
                        }

                        // إضافة للـ ZIP
                        const imgData = tCanvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                        const safeName = guest.name.replace(/[^a-z0-9\u0600-\u06FF]/gi, "_");
                        folder.file(`${safeName}.jpg`, imgData, {base64: true});
                        
                        // تنظيف فوري
                        tCanvas.width = 1; tCanvas.height = 1;
                    }
                }

                // تحميل ملف ZIP للدفعة الحالية
                pSubText.innerText = "جاري تحميل الملف المضغوط...";
                const content = await zip.generateAsync({type:"blob"});
                saveAs(content, `Invitations_Part${chunkIndex + 1}.zip`);

                // تنظيف الذاكرة بشكل صريح
                zip = null; 
                
                // انتظار 3 ثواني قبل الدفعة التالية (لإعطاء فرصة للتحميل)
                pSubText.innerText = "استراحة قصيرة لتنظيف الذاكرة...";
                await new Promise(r => setTimeout(r, 3000));

                // الانتقال للدفعة التالية
                processChunk(chunkIndex + 1);
            };

            // البدء
            processChunk(0);
        }

    </script>
</body>
</html>
