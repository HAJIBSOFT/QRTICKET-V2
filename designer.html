<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HAJIB | التحميل اليدوي</title>
    
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --bg: #111827; --panel: #1f2937; --primary: #3b82f6; --text: #f3f4f6; --success: #10b981; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; font-family: 'Tajawal', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Header */
        header { background: var(--panel); padding: 10px 15px; height: 50px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #374151; }
        .brand { font-weight: 800; color: var(--primary); font-size: 1rem; }
        
        /* القائمة المنسدلة للضيوف */
        .guest-select-container { flex: 1; margin: 0 10px; max-width: 200px; }
        select { width: 100%; background: #374151; color: white; border: 1px solid #4b5563; padding: 5px; border-radius: 5px; font-family: inherit; }

        /* منطقة العمل */
        .workspace { flex: 1; display: flex; flex-direction: column; position: relative; }

        /* المعاينة */
        .preview-container {
            flex: 1; background: #000; display: flex; justify-content: center; align-items: center;
            overflow: hidden; 
            background-image: radial-gradient(#333 1px, transparent 1px); background-size: 20px 20px;
        }
        /* الكانفاس يظهر مصغراً ليناسب الشاشة لكنه يحتفظ بدقته داخلياً */
        canvas { 
            max-width: 95%; max-height: 95%; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5); 
            object-fit: contain;
        }

        /* أدوات التحكم السفلية */
        .bottom-bar {
            background: var(--panel); border-top: 1px solid #374151;
            padding: 10px; display: flex; flex-direction: column; gap: 10px;
            z-index: 100;
        }

        /* أزرار التنقل والتحميل */
        .nav-controls { display: flex; gap: 10px; align-items: center; justify-content: space-between; }
        .btn-nav { background: #374151; color: white; border: 1px solid #4b5563; width: 50px; height: 50px; border-radius: 10px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center;}
        .btn-download { flex: 1; background: var(--success); color: white; border: none; height: 50px; border-radius: 10px; font-weight: bold; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
        .btn-download:active { transform: scale(0.98); }

        /* زر الإعدادات */
        .settings-toggle { text-align: center; color: #9ca3af; font-size: 0.8rem; padding: 5px; cursor: pointer; border-top: 1px solid rgba(255,255,255,0.05); margin-top: 5px;}
        
        /* لوحة الإعدادات (مخفية افتراضياً) */
        .settings-panel {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 60%; 
            background: rgba(31, 41, 55, 0.98); backdrop-filter: blur(10px);
            border-top: 1px solid var(--primary);
            transition: transform 0.3s ease;
            transform: translateY(100%); /* مخفية للأسفل */
            z-index: 200; display: flex; flex-direction: column;
        }
        .settings-panel.open { transform: translateY(0); }
        
        .settings-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .settings-content { flex: 1; overflow-y: auto; padding: 20px; }
        
        .control-row { margin-bottom: 20px; }
        label { display: flex; justify-content: space-between; color: #d1d5db; margin-bottom: 8px; font-size: 0.9rem; }
        input[type="range"] { width: 100%; height: 6px; background: #4b5563; border-radius: 5px; appearance: none; }
        input[type="range"]::-webkit-slider-thumb { appearance: none; width: 22px; height: 22px; background: var(--primary); border-radius: 50%; border: 2px solid white; }
    </style>
</head>
<body>

    <header>
        <div class="brand">HAJIB</div>
        <div class="guest-select-container">
            <select id="guestSelect" onchange="jumpToGuest()">
                <option value="-1">جاري التحميل...</option>
            </select>
        </div>
        <div style="font-size:0.8rem; color:#9ca3af;" id="counterDisplay">0/0</div>
    </header>

    <div class="workspace">
        <div class="preview-container">
            <canvas id="canvas"></canvas>
        </div>

        <div class="bottom-bar">
            <!-- أزرار التحكم الرئيسية -->
            <div class="nav-controls">
                <button class="btn-nav" onclick="prevGuest()"><i class="fas fa-chevron-right"></i></button>
                
                <button class="btn-download" onclick="downloadCurrentPNG()">
                    <i class="fas fa-download"></i> تحميل PNG
                </button>
                
                <button class="btn-nav" onclick="nextGuest()"><i class="fas fa-chevron-left"></i></button>
            </div>
            
            <div class="settings-toggle" onclick="toggleSettings()">
                <i class="fas fa-sliders-h"></i> تعديل التصميم والمواقع
            </div>
        </div>

        <!-- لوحة الإعدادات المنبثقة -->
        <div class="settings-panel" id="settingsPanel">
            <div class="settings-header">
                <span style="font-weight:bold; color:var(--primary);">إعدادات التصميم</span>
                <button onclick="toggleSettings()" style="background:none; border:none; color:white; font-size:1.2rem;"><i class="fas fa-times"></i></button>
            </div>
            <div class="settings-content">
                <!-- رفع الصورة -->
                <div class="control-row">
                    <label>صورة الخلفية</label>
                    <input type="file" id="bgInput" accept="image/*" style="width:100%; padding:10px; background:#111827; border-radius:5px; color:white;">
                </div>

                <!-- إعدادات الاسم -->
                <div class="control-row" style="border-top:1px solid rgba(255,255,255,0.1); padding-top:15px;">
                    <label>
                        <span>إظهار الاسم</span>
                        <input type="checkbox" id="showName" checked style="width:20px; height:20px;">
                    </label>
                </div>
                <div class="control-row">
                    <label>حجم الخط <span><b id="val-textSize">40</b>px</span></label>
                    <input type="range" id="textSize" min="10" max="200" value="40">
                </div>
                <div class="control-row">
                    <label>موضع الاسم (X)</label>
                    <input type="range" id="textX" min="0" max="2000" value="50">
                </div>
                <div class="control-row">
                    <label>موضع الاسم (Y)</label>
                    <input type="range" id="textY" min="0" max="2000" value="300">
                </div>
                <div class="control-row">
                    <label>لون النص</label>
                    <input type="color" id="textColor" value="#ffffff" style="width:100%; height:40px; border:none;">
                </div>

                <!-- إعدادات الباركود -->
                <div class="control-row" style="border-top:1px solid rgba(255,255,255,0.1); padding-top:15px; margin-top:15px;">
                    <label>حجم الباركود <span><b id="val-qrSize">150</b>px</span></label>
                    <input type="range" id="qrSize" min="50" max="600" value="150">
                </div>
                <div class="control-row">
                    <label>موضع الباركود (X)</label>
                    <input type="range" id="qrX" min="0" max="2000" value="50">
                </div>
                <div class="control-row">
                    <label>موضع الباركود (Y)</label>
                    <input type="range" id="qrY" min="0" max="2000" value="50">
                </div>
            </div>
        </div>
    </div>

    <!-- عنصر مخفي لتوليد QR -->
    <div id="hiddenQR" style="display:none;"></div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzcJyxjZ4DcOKkboUYvDOrkWs5PVsKScetEzEvSXwzIL3sFGb0JHHVpTzZRksiaBJsW/exec';
        
        // المتغيرات العامة
        let guests = [];
        let currentIndex = 0;
        let bgImg = new Image();
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // إعدادات التصميم
        const state = {
            qrSize: 150, qrX: 50, qrY: 50,
            showName: true, textSize: 40, textX: 50, textY: 300, textColor: '#ffffff'
        };

        // صورة افتراضية
        bgImg.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA+gAAALQCAIAAACw5t5xAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAABTSURBVHhe7cExAQAAAMKg9U9tDQ8gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4McIsHgAAa1w1XEAAAAASUVORK5CYII=";
        bgImg.onload = renderCurrentGuest;

        // --- 1. جلب البيانات ---
        async function fetchData() {
            try {
                const formData = new FormData(); formData.append('action', 'getDetailedReport');
                const res = await fetch(API_URL, { method: 'POST', body: formData });
                const data = await res.json();
                
                if(data.success) {
                    guests = [...data.attendedGuests, ...data.notAttendedGuests];
                    populateDropdown();
                    updateCounter();
                    renderCurrentGuest();
                }
            } catch(e) { alert("خطأ في الاتصال"); }
        }
        fetchData();

        // --- 2. إدارة الواجهة ---
        function populateDropdown() {
            const select = document.getElementById('guestSelect');
            select.innerHTML = '';
            guests.forEach((g, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.innerText = `${i+1}. ${g.name}`;
                select.appendChild(opt);
            });
        }

        function updateCounter() {
            document.getElementById('counterDisplay').innerText = `${currentIndex + 1} / ${guests.length}`;
            document.getElementById('guestSelect').value = currentIndex;
        }

        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('open');
        }

        // --- 3. التنقل ---
        window.nextGuest = () => {
            if(currentIndex < guests.length - 1) {
                currentIndex++;
                updateCounter();
                renderCurrentGuest();
            }
        };

        window.prevGuest = () => {
            if(currentIndex > 0) {
                currentIndex--;
                updateCounter();
                renderCurrentGuest();
            }
        };

        window.jumpToGuest = () => {
            currentIndex = parseInt(document.getElementById('guestSelect').value);
            updateCounter();
            renderCurrentGuest();
        };

        // --- 4. الرسم (Render) ---
        async function renderCurrentGuest() {
            if(guests.length === 0) return;
            const guest = guests[currentIndex];

            // 1. توليد QR
            const tempDiv = document.getElementById('hiddenQR');
            tempDiv.innerHTML = '';
            new QRCode(tempDiv, { text: guest.qrCode, width: state.qrSize, height: state.qrSize });

            // انتظار بسيط لضمان رسم الـ QR
            await new Promise(r => setTimeout(r, 50));
            const qrImg = tempDiv.querySelector('img');

            // 2. إعداد الكانفاس بدقة الصورة الأصلية
            canvas.width = bgImg.width || 800;
            canvas.height = bgImg.height || 600;

            // 3. الرسم
            ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);

            if(qrImg) {
                ctx.drawImage(qrImg, state.qrX, state.qrY, state.qrSize, state.qrSize);
            } else {
                // رسم مربع وهمي في حال تأخر الـ QR
                ctx.fillStyle = "#000"; ctx.fillRect(state.qrX, state.qrY, state.qrSize, state.qrSize);
            }

            if(state.showName) {
                ctx.font = `bold ${state.textSize}px 'Tajawal'`;
                ctx.fillStyle = state.textColor;
                ctx.textAlign = 'right';
                ctx.fillText(guest.name, state.textX, state.textY);
            }
        }

        // --- 5. ربط الإعدادات ---
        const bind = (id) => {
            const el = document.getElementById(id);
            el.addEventListener('input', (e) => {
                let val = e.target.type === 'checkbox' ? e.target.checked : e.target.value;
                if(e.target.type === 'range') val = parseInt(val);
                state[id] = val;
                const badge = document.getElementById('val-' + id);
                if(badge) badge.innerText = val;
                renderCurrentGuest();
            });
        };
        ['qrSize', 'qrX', 'qrY', 'textSize', 'textX', 'textY', 'textColor', 'showName'].forEach(bind);

        document.getElementById('bgInput').addEventListener('change', (e) => {
            if(e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    bgImg = new Image();
                    bgImg.onload = () => {
                        const max = Math.max(bgImg.width, bgImg.height);
                        ['qrX','qrY','textX','textY'].forEach(id => document.getElementById(id).max = max);
                        renderCurrentGuest();
                    };
                    bgImg.src = evt.target.result;
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        // --- 6. التحميل ---
        function downloadCurrentPNG() {
            if(guests.length === 0) return;
            const guest = guests[currentIndex];
            
            // تحويل الكانفاس إلى BLOB بأعلى دقة ممكنة
            canvas.toBlob(function(blob) {
                const safeName = guest.name.replace(/[^a-z0-9\u0600-\u06FF]/gi, "_");
                saveAs(blob, `${safeName}.png`);
            }, "image/png", 1.0); // 1.0 = Max Quality
        }

    </script>
</body>
</html>
