<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAJIB | لوحة الإدارة</title>
    
    <!-- مكتبة QR -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    
    <!-- الخطوط والأيقونات -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-body: #0f172a;
            --bg-sidebar: #1e293b;
            --bg-panel: #1e293b;
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: rgba(255, 255, 255, 0.08);
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 999;
            transition: transform 0.3s ease;
            right: 0; /* للغة العربية */
        }

        .logo-area {
            padding: 25px;
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
        }

        .close-sidebar-btn { display: none; background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }

        .nav-links {
            list-style: none;
            padding: 20px 10px;
            flex: 1;
        }

        .nav-links li { margin-bottom: 8px; }

        .nav-btn {
            width: 100%;
            background: none;
            border: none;
            padding: 12px 15px;
            color: var(--text-muted);
            font-family: inherit;
            font-size: 1rem;
            text-align: right;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.2s;
            display: flex; align-items: center; gap: 12px;
        }

        .nav-btn:hover, .nav-btn.active {
            background: rgba(99, 102, 241, 0.1);
            color: var(--text-main);
        }
        .nav-btn.active { border-right: 3px solid var(--primary); }

        /* --- Main Content --- */
        .main-content {
            margin-right: 260px; 
            flex: 1;
            padding: 30px;
            width: calc(100% - 260px);
            transition: margin 0.3s ease;
        }

        /* زر القائمة للموبايل */
        .mobile-header {
            display: none;
            margin-bottom: 20px;
            align-items: center;
            gap: 15px;
        }
        .menu-toggle-btn {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .header-top {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap; gap: 15px;
        }
        .page-title { font-size: 1.8rem; font-weight: 700; }

        /* --- Sections --- */
        .section-view { display: none; animation: fadeIn 0.3s ease; }
        .section-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Cards --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 25px;
            position: relative;
            overflow: hidden;
        }
        .card h3 { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 10px; }
        .card .value { font-size: 2.2rem; font-weight: 700; }
        .card .icon-bg {
            position: absolute; left: -10px; bottom: -10px;
            font-size: 5rem; opacity: 0.05; transform: rotate(15deg);
        }

        /* --- Tables --- */
        .panel {
            background: var(--bg-panel);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
            margin-bottom: 20px;
        }
        .panel-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; gap: 10px;
        }
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px 25px; text-align: right; border-bottom: 1px solid var(--border); white-space: nowrap; }
        th { background: rgba(0,0,0,0.2); color: var(--text-muted); font-weight: 600; font-size: 0.9rem; }
        tr:hover td { background: rgba(255,255,255,0.02); }

        /* --- Buttons --- */
        .btn {
            padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer;
            font-family: inherit; font-weight: 600; transition: 0.2s;
            display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: rgba(255,255,255,0.05); color: var(--text-main); border: 1px solid var(--border); }
        .btn-icon {
            width: 32px; height: 32px; border-radius: 6px; border: none; cursor: pointer;
            display: inline-flex; align-items: center; justify-content: center;
            color: white; margin-left: 5px; transition: 0.2s;
        }
        .action-whatsapp { background: #25D366; }
        .action-copy { background: #3b82f6; }
        .action-download { background: #f59e0b; }

        /* --- Inputs --- */
        .form-control {
            width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--border);
            padding: 12px; border-radius: 10px; color: white; font-family: inherit; margin-bottom: 15px;
        }

        /* --- Overlay for Mobile --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 998;
            display: none;
        }

        /* --- Print Container (Hidden normally) --- */
        #print-container {
            display: none;
            background: white;
            color: black;
            padding: 20px;
        }

        /* --- Responsive --- */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(100%); width: 280px; } /* مخفية لليمين */
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-right: 0; width: 100%; padding: 20px; }
            .mobile-header { display: flex; }
            .close-sidebar-btn { display: block; }
            .header-top { flex-direction: column; align-items: flex-start; }
            .btn { width: 100%; justify-content: center; }
        }

        /* --- Print Styles --- */
        @media print {
            body { background: white; color: black; overflow: visible; }
            .sidebar, .main-content, .overlay, .mobile-header, .btn, .no-print { display: none !important; }
            
            #print-container { 
                display: block !important; 
                position: absolute; top: 0; left: 0; width: 100%; 
            }
            
            /* تنسيق طباعة الباركودات (Grid) */
            .print-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
            }
            .print-ticket {
                border: 2px dashed #333;
                padding: 10px;
                text-align: center;
                border-radius: 8px;
                page-break-inside: avoid;
            }
            .print-ticket img { max-width: 100px; display: block; margin: 0 auto 5px; }
            .print-ticket h3 { font-size: 14px; margin: 5px 0; }
            .print-ticket p { font-size: 12px; color: #555; margin: 0; }

            /* تنسيق طباعة التقارير (Table) */
            .print-table { width: 100%; border-collapse: collapse; }
            .print-table th, .print-table td { border: 1px solid #000; padding: 8px; text-align: right; color: black; }
            .print-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
        }
    </style>
</head>
<body>

    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="logo-area">
            <div><i class="fas fa-qrcode"></i> HAJIB ADMIN</div>
            <button class="close-sidebar-btn" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
        </div>
        <ul class="nav-links">
            <li><button class="nav-btn active" onclick="switchTab('dashboard', this)"><i class="fas fa-home"></i> الرئيسية</button></li>
            <li><button class="nav-btn" onclick="switchTab('guests', this)"><i class="fas fa-users"></i> إدارة المدعوين</button></li>
            <li><button class="nav-btn" onclick="switchTab('generate', this)"><i class="fas fa-magic"></i> إصدار جديد</button></li>
            <li><button class="nav-btn" onclick="switchTab('reports', this)"><i class="fas fa-chart-pie"></i> التقارير</button></li>
        </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        
        <!-- Mobile Header -->
        <div class="mobile-header">
            <button class="menu-toggle-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            <span style="font-weight:bold; font-size:1.2rem;">HAJIB</span>
        </div>

        <!-- Dashboard View -->
        <section id="dashboard" class="section-view active">
            <div class="header-top">
                <h1 class="page-title">لوحة المعلومات</h1>
                <button class="btn btn-secondary" onclick="loadData()"><i class="fas fa-sync-alt"></i> تحديث</button>
            </div>

            <div class="stats-grid">
                <div class="card">
                    <h3>إجمالي المدعوين</h3>
                    <div class="value" id="stat-total">0</div>
                    <i class="fas fa-users icon-bg"></i>
                </div>
                <div class="card" style="border-color: var(--success);">
                    <h3 style="color: var(--success);">الحضور الفعلي</h3>
                    <div class="value" id="stat-attended">0</div>
                    <i class="fas fa-check-circle icon-bg" style="color: var(--success);"></i>
                </div>
                <div class="card" style="border-color: var(--danger);">
                    <h3 style="color: var(--danger);">لم يحضروا</h3>
                    <div class="value" id="stat-pending">0</div>
                    <i class="fas fa-clock icon-bg" style="color: var(--danger);"></i>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <h4><i class="fas fa-history"></i> آخر عمليات الدخول</h4>
                </div>
                <div class="table-responsive">
                    <table id="recent-scans-table">
                        <thead><tr><th>الاسم</th><th>الوقت</th><th>الكود</th></tr></thead>
                        <tbody><tr><td colspan="3" style="text-align:center">جاري التحميل...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Guests Management View -->
        <section id="guests" class="section-view">
            <div class="header-top">
                <h1 class="page-title">قائمة المدعوين</h1>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="preparePrintAllTickets()"><i class="fas fa-print"></i> طباعة باركودات الكل</button>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <input type="text" id="searchGuest" class="form-control" style="width: 300px; margin:0;" placeholder="بحث عن اسم..." onkeyup="filterGuests()">
                </div>
                <div class="table-responsive">
                    <table id="all-guests-table">
                        <thead><tr><th>الاسم</th><th>الحالة</th><th>الكود</th><th>إجراءات</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Generate View -->
        <section id="generate" class="section-view">
            <div class="header-top"><h1 class="page-title">إصدار دعوات جديدة</h1></div>
            <div class="panel" style="padding: 25px;">
                <label>عنوان المناسبة</label>
                <input type="text" id="eventTitle" class="form-control" placeholder="مثال: حفل الزواج">
                <label>أسماء الضيوف (كل اسم في سطر)</label>
                <textarea id="newGuestNames" class="form-control" style="min-height: 120px;" placeholder="محمد أحمد&#10;علي خالد"></textarea>
                <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="generateTickets()">
                    <i class="fas fa-plus-circle"></i> إنشاء وإضافة
                </button>
            </div>
        </section>

        <!-- Reports View -->
        <section id="reports" class="section-view">
            <div class="header-top">
                <h1 class="page-title">التقارير التفصيلية</h1>
                <button class="btn btn-secondary" onclick="preparePrintReport()"><i class="fas fa-print"></i> طباعة التقرير</button>
            </div>
            <div class="panel">
                <div class="panel-header"><h4><i class="fas fa-list"></i> سجل الحضور الكامل</h4></div>
                <div class="table-responsive">
                    <table id="report-table">
                        <thead><tr><th>الاسم</th><th>الحالة</th><th>وقت الدخول</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

    <!-- Hidden Print Container -->
    <div id="print-container"></div>
    <!-- Helper Div for download image -->
    <div id="tempQR" style="display:none;"></div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzcJyxjZ4DcOKkboUYvDOrkWs5PVsKScetEzEvSXwzIL3sFGb0JHHVpTzZRksiaBJsW/exec'; 
        const TICKET_BASE_URL = 'https://hajibsoft.github.io/QRTICKET-V2/PublicTicketView.html';
        let allGuestsData = [];

        // --- Sidebar Logic ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.classList.toggle('active');
            overlay.style.display = sidebar.classList.contains('active') ? 'block' : 'none';
        }

        function switchTab(tabId, btn) {
            document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            if(btn) btn.classList.add('active');
            if(window.innerWidth <= 768) toggleSidebar(); // Close on mobile click
        }

        // --- Data Loading ---
        async function loadData() {
            const tbody = document.querySelector('#all-guests-table tbody');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">جاري التحديث...</td></tr>';
            
            try {
                const formData = new FormData();
                formData.append('action', 'getDetailedReport');
                const res = await fetch(API_URL, { method: 'POST', body: formData });
                const data = await res.json();

                if (data.success) {
                    allGuestsData = [
                        ...data.attendedGuests.map(g => ({...g, status: 'attended'})),
                        ...data.notAttendedGuests.map(g => ({...g, status: 'pending', arrivalTime: '-'}))
                    ];
                    
                    document.getElementById('stat-total').innerText = data.totalInvited;
                    document.getElementById('stat-attended').innerText = data.attendedCount;
                    document.getElementById('stat-pending').innerText = data.notAttendedCount;
                    renderTables();
                }
            } catch (err) { alert("خطأ في الاتصال"); }
        }

        function renderTables() {
            const tbody = document.querySelector('#all-guests-table tbody');
            tbody.innerHTML = '';
            
            allGuestsData.forEach(guest => {
                const link = `${TICKET_BASE_URL}?qrData=${encodeURIComponent(guest.qrCode)}`;
                const statusHtml = guest.status === 'attended' 
                    ? '<span style="color:var(--success)">حاضر</span>' 
                    : '<span style="color:var(--text-muted)">لم يحضر</span>';
                
                tbody.innerHTML += `
                    <tr>
                        <td style="font-weight:bold">${guest.name}</td>
                        <td>${statusHtml}</td>
                        <td style="font-family:monospace">${guest.qrCode}</td>
                        <td>
                            <button class="btn-icon action-whatsapp" onclick="shareWhatsapp('${guest.name}', '${link}')"><i class="fab fa-whatsapp"></i></button>
                            <button class="btn-icon action-copy" onclick="copyLink('${link}')"><i class="fas fa-copy"></i></button>
                            <button class="btn-icon action-download" onclick="downloadQR('${guest.qrCode}', '${guest.name}')"><i class="fas fa-download"></i></button>
                        </td>
                    </tr>`;
            });

            // Report Table
            const reportBody = document.querySelector('#report-table tbody');
            reportBody.innerHTML = '';
            allGuestsData.forEach(g => {
                reportBody.innerHTML += `<tr><td>${g.name}</td><td>${g.status === 'attended'?'حاضر':'غائب'}</td><td>${g.arrivalTime}</td></tr>`;
            });
            
            // Recent
            const recentBody = document.querySelector('#recent-scans-table tbody');
            const recent = allGuestsData.filter(g => g.status === 'attended').slice(0, 5);
            recentBody.innerHTML = recent.length ? '' : '<tr><td colspan="3" style="text-align:center">لا يوجد حضور بعد</td></tr>';
            recent.forEach(g => {
                recentBody.innerHTML += `<tr><td>${g.name}</td><td>${g.arrivalTime}</td><td>${g.qrCode}</td></tr>`;
            });
        }

        // --- Generate ---
        async function generateTickets() {
            const names = document.getElementById('newGuestNames').value;
            if(!names.trim()) return alert("أدخل الأسماء");
            
            if(!confirm("هل أنت متأكد من إنشاء تذاكر لهذه الأسماء؟")) return;

            const btn = document.querySelector('#generate .btn-primary');
            btn.innerHTML = 'جاري الإنشاء...'; btn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('action', 'generateTicketsBatch');
                formData.append('guestNamesList', names);
                await fetch(API_URL, { method: 'POST', body: formData });
                alert("تم الإنشاء بنجاح");
                document.getElementById('newGuestNames').value = '';
                loadData();
                switchTab('guests');
            } catch(e) { alert("حدث خطأ"); }
            btn.innerHTML = '<i class="fas fa-plus-circle"></i> إنشاء وإضافة'; btn.disabled = false;
        }

        // --- Helper Actions ---
        function shareWhatsapp(n, l) { window.open(`https://wa.me/?text=مرحباً ${n}، تذكرتك: ${encodeURIComponent(l)}`, '_blank'); }
        function copyLink(l) { navigator.clipboard.writeText(l).then(()=>alert("تم النسخ")); }
        function filterGuests() {
            const val = document.getElementById('searchGuest').value.toLowerCase();
            document.querySelectorAll('#all-guests-table tbody tr').forEach(row => {
                row.style.display = row.cells[0].innerText.toLowerCase().includes(val) ? '' : 'none';
            });
        }
        function downloadQR(code, name) {
            const div = document.getElementById('tempQR');
            div.innerHTML = '';
            new QRCode(div, { text: code, width: 250, height: 250 });
            setTimeout(() => {
                const img = div.querySelector('img');
                if(img) {
                    const a = document.createElement('a');
                    a.href = img.src; a.download = `Ticket-${name}.png`; a.click();
                }
            }, 500);
        }

        // --- Print Logic (Solved Issues) ---
        
        // 1. طباعة الباركودات (صور حقيقية)
        function preparePrintAllTickets() {
            if(allGuestsData.length === 0) return alert("لا يوجد بيانات");
            const container = document.getElementById('print-container');
            container.innerHTML = '<div class="print-grid"></div>';
            const grid = container.querySelector('.print-grid');
            const eventName = document.getElementById('eventTitle').value || "بطاقة دعوة";

            // إنشاء العناصر
            allGuestsData.forEach(guest => {
                const card = document.createElement('div');
                card.className = 'print-ticket';
                // div للباركود
                const qrDiv = document.createElement('div');
                card.appendChild(qrDiv);
                
                // توليد الباركود
                new QRCode(qrDiv, { text: guest.qrCode, width: 100, height: 100 });
                
                card.innerHTML += `<h3>${guest.name}</h3><p>${eventName}</p>`;
                grid.appendChild(card);
            });

            // *الحل السحري*: الانتظار حتى تقوم المكتبة بتحويل Canvas إلى Image
            // مكتبة qrcodejs تأخذ وقتاً بسيطاً لإضافة تاج <img>
            setTimeout(() => {
                window.print();
            }, 1000); // انتظار ثانية كاملة لضمان الريندر
        }

        // 2. طباعة التقرير (نقل الجدول)
        function preparePrintReport() {
            if(allGuestsData.length === 0) return alert("لا يوجد بيانات");
            const container = document.getElementById('print-container');
            container.innerHTML = '';
            
            const header = document.createElement('div');
            header.className = 'print-header';
            header.innerHTML = `<h1>تقرير الحضور</h1><p>تاريخ الطباعة: ${new Date().toLocaleDateString('ar-SA')}</p>`;
            
            const originalTable = document.getElementById('report-table').cloneNode(true);
            originalTable.className = 'print-table'; // تطبيق ستايل الطباعة
            
            container.appendChild(header);
            container.appendChild(originalTable);
            
            setTimeout(() => {
                window.print();
            }, 300);
        }

        // Init
        window.onload = loadData;

    </script>
</body>
</html>
